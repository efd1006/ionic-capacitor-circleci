version: 2
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_app
  jobs:
    build_app:
      docker:
        - image: circleci/android:api-28-node
      working_directory: ~/repo
      environment:
        JVM_OPTS: -Xmx3200m
      steps:
        - checkout
        - run: 
            name: "Install gradle"
            command: |
              wget https://services.gradle.org/distributions/gradle-4.0.2-bin.zip -P /tmp
              sudo unzip -d /opt/gradle /tmp/gradle-*.zip
              echo 'export GRADLE_HOME=/opt/gradle/gradle-4.0.2' >> $BASH_ENV
              echo 'export PATH=$PATH:/opt/gradle/gradle-4.0.2/bin' >> $BASH_ENV
              source $BASH_ENV
        - run:
            name: "Install ionic and cordova"
            command: |
              sudo npm install -g ionic cordova yarn
        - run:
            name: "Install npm packages and build project"
            command: |
              npm install
              ionic build
        - run:
            name: "Add android project"
            command: |
              npx cap add android
              npx cap sync android
        - run:
            name: "Generate apk"
            command: |
              cd android
              ./gradlew :app:assembleDebug
              cp -r platforms/android/app/build/outputs/apk/debug/app-debug.apk /tmp/apk
        - store_artifacts:
            path: /tmp/apk
            destination: apks

